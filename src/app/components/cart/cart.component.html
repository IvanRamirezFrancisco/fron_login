<!-- ========================================
     CARRITO DE COMPRAS - CASA DE MÚSICA CASTILLO
     ======================================== -->

<div class="cart-page">
  
  <!-- HEADER DEL CARRITO -->
  <div class="cart-header">
    <div class="container">
      <div class="breadcrumb">
        <a routerLink="/home" class="breadcrumb-link">
          <span class="material-icons">home</span>
          Inicio
        </a>
        <span class="material-icons">chevron_right</span>
        <span class="breadcrumb-current">Carrito de Compras</span>
      </div>
      
      <div class="header-content">
        <div class="header-left">
          <h1 class="page-title">
            <span class="material-icons">shopping_cart</span>
            Mi Carrito
          </h1>
          <p class="items-count" *ngIf="cartItems.length > 0">
            {{ getTotalItems() }} {{ getTotalItems() === 1 ? 'artículo' : 'artículos' }}
          </p>
        </div>
        
        <button 
          class="btn-continue-shopping"
          routerLink="/catalogo"
        >
          <span class="material-icons">arrow_back</span>
          Seguir Comprando
        </button>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="cart-body">
    <div class="container">
      
      <!-- CARRITO VACÍO -->
      <div class="empty-cart" *ngIf="cartItems.length === 0">
        <div class="empty-icon">
          <span class="material-icons">shopping_cart</span>
        </div>
        <h2 class="empty-title">Tu carrito está vacío</h2>
        <p class="empty-text">¡Descubre nuestra colección de instrumentos musicales!</p>
        <button class="btn-explore" routerLink="/catalogo">
          <span class="material-icons">explore</span>
          Explorar Catálogo
        </button>
      </div>

      <!-- CARRITO CON PRODUCTOS -->
      <div class="cart-layout" *ngIf="cartItems.length > 0">
        
        <!-- COLUMNA IZQUIERDA: PRODUCTOS -->
        <div class="products-section">
          
          <!-- Acciones del carrito -->
          <div class="cart-actions-bar">
            <p class="items-summary">
              <span class="material-icons">inventory_2</span>
              {{ getTotalItems() }} {{ getTotalItems() === 1 ? 'producto' : 'productos' }} en tu carrito
            </p>
            
            <button 
              class="btn-clear-cart"
              (click)="showClearConfirm = true"
              *ngIf="cartItems.length > 0"
            >
              <span class="material-icons">delete_outline</span>
              Vaciar carrito
            </button>
          </div>

          <!-- Lista de productos -->
          <div class="products-list">
            <div 
              class="product-card"
              *ngFor="let item of cartItems; trackBy: trackByProductId"
              [@slideIn]
            >
              <!-- Imagen del producto -->
              <div class="product-image">
                <img 
                  [src]="item.product.images[0]" 
                  [alt]="item.product.name"
                  (error)="onImageError($event)"
                />
                <span class="stock-badge" *ngIf="item.product.stockQuantity < 10">
                  Solo {{ item.product.stockQuantity }} disponibles
                </span>
              </div>

              <!-- Información del producto -->
              <div class="product-details">
                <h3 class="product-name">{{ item.product.name }}</h3>
                <p class="product-brand">
                  <span class="material-icons">verified</span>
                  {{ item.product.brand }}
                </p>
                
                <!-- Opciones seleccionadas -->
                <div class="product-options" *ngIf="item.selectedOptions">
                  <span 
                    class="option-badge"
                    *ngFor="let option of getSelectedOptionsArray(item.selectedOptions)"
                  >
                    {{ option.key }}: {{ option.value }}
                  </span>
                </div>

                <!-- Acciones del producto -->
                <div class="product-actions">
                  <button 
                    class="action-btn remove"
                    (click)="removeItem(item)"
                    title="Eliminar del carrito"
                  >
                    <span class="material-icons">delete_outline</span>
                    Eliminar
                  </button>
                </div>
              </div>

              <!-- Precio y cantidad -->
              <div class="product-pricing">
                <!-- Precio unitario -->
                <div class="price-section">
                  <div class="price-main">
                    <span class="price-current">${{ item.product.price | number:'1.2-2' }}</span>
                    <span class="price-unit">c/u</span>
                  </div>
                  <div class="price-original" *ngIf="item.product.originalPrice && item.product.discount">
                    <span class="price-crossed">${{ item.product.originalPrice | number:'1.2-2' }}</span>
                    <span class="discount-badge">-{{ item.product.discount }}%</span>
                  </div>
                </div>

                <!-- Control de cantidad -->
                <div class="quantity-section">
                  <label class="quantity-label">Cantidad</label>
                  <div class="quantity-controls">
                    <button 
                      class="qty-btn"
                      (click)="decreaseQuantity(item)"
                      [disabled]="item.quantity <= 1 || updating"
                    >
                      <span class="material-icons">remove</span>
                    </button>
                    
                    <input 
                      type="number" 
                      class="qty-input"
                      [value]="item.quantity"
                      (blur)="updateQuantityFromInput(item, $event)"
                      [max]="item.product.stockQuantity"
                      min="1"
                    />
                    
                    <button 
                      class="qty-btn"
                      (click)="increaseQuantity(item)"
                      [disabled]="item.quantity >= item.product.stockQuantity || updating"
                    >
                      <span class="material-icons">add</span>
                    </button>
                  </div>
                </div>

                <!-- Subtotal del producto -->
                <div class="item-total">
                  <span class="total-label">Subtotal</span>
                  <span class="total-price">${{ getItemTotal(item) | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- COLUMNA DERECHA: RESUMEN -->
        <aside class="summary-section">
          <div class="summary-card sticky">
            
            <!-- Header del resumen -->
            <div class="summary-header">
              <h2 class="summary-title">Resumen del Pedido</h2>
            </div>

            <!-- Detalles del resumen -->
            <div class="summary-details">
              <div class="detail-row">
                <span class="detail-label">Subtotal ({{ getTotalItems() }} productos)</span>
                <span class="detail-value">${{ cartSubtotal | number:'1.2-2' }}</span>
              </div>
              
              <div class="detail-row">
                <span class="detail-label">Envío</span>
                <span class="detail-value" [class.free]="cartShipping === 0">
                  {{ cartShipping === 0 ? 'GRATIS' : ('$' + (cartShipping | number:'1.2-2')) }}
                </span>
              </div>

              <!-- Barra de progreso envío gratis -->
              <div class="free-shipping-progress" *ngIf="cartSubtotal < freeShippingThreshold">
                <div class="progress-info">
                  <span class="material-icons">local_shipping</span>
                  <span class="progress-text">
                    ¡Agrega <strong>${{ (freeShippingThreshold - cartSubtotal) | number:'1.2-2' }}</strong> más para envío gratis!
                  </span>
                </div>
                <div class="progress-bar">
                  <div 
                    class="progress-fill"
                    [style.width.%]="(cartSubtotal / freeShippingThreshold) * 100"
                  ></div>
                </div>
              </div>

              <div class="free-shipping-achieved" *ngIf="cartSubtotal >= freeShippingThreshold">
                <span class="material-icons">check_circle</span>
                <span>¡Envío gratis aplicado!</span>
              </div>
              
              <div class="detail-row">
                <span class="detail-label">IVA (16%)</span>
                <span class="detail-value">${{ cartTaxes | number:'1.2-2' }}</span>
              </div>

              <div class="divider"></div>

              <div class="detail-row total-row">
                <span class="detail-label">Total</span>
                <span class="detail-value total-value">${{ cartTotal | number:'1.2-2' }}</span>
              </div>
            </div>

            <!-- Cupón de descuento -->
            <div class="coupon-section">
              <button class="coupon-toggle" (click)="toggleCoupon()">
                <span class="material-icons">local_offer</span>
                ¿Tienes un cupón de descuento?
                <span class="material-icons">{{ showCouponInput ? 'expand_less' : 'expand_more' }}</span>
              </button>
              
              <div class="coupon-input-wrapper" *ngIf="showCouponInput" [@slideIn]>
                <input 
                  type="text" 
                  class="coupon-input" 
                  placeholder="Código del cupón"
                  [(ngModel)]="couponCode"
                />
                <button class="btn-apply-coupon" (click)="applyCoupon()">
                  Aplicar
                </button>
              </div>
            </div>

            <!-- Botón de checkout -->
            <button 
              class="btn-checkout"
              (click)="proceedToCheckout()"
              [disabled]="cartItems.length === 0 || updating"
            >
              <span class="material-icons">lock</span>
              Proceder al Pago
            </button>

            <!-- Métodos de pago aceptados -->
            <div class="payment-methods">
              <p class="methods-title">Métodos de pago aceptados</p>
              <div class="methods-icons">
                <span class="material-icons" title="Tarjetas de crédito">credit_card</span>
                <span class="material-icons" title="PayPal">account_balance_wallet</span>
                <span class="material-icons" title="Transferencia">account_balance</span>
                <span class="material-icons" title="Efectivo">payments</span>
              </div>
            </div>

            <!-- Garantías -->
            <div class="guarantees">
              <div class="guarantee-item">
                <span class="material-icons">verified_user</span>
                <span>Compra 100% segura</span>
              </div>
              <div class="guarantee-item">
                <span class="material-icons">cached</span>
                <span>30 días de devolución</span>
              </div>
              <div class="guarantee-item">
                <span class="material-icons">support_agent</span>
                <span>Soporte 24/7</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACIÓN PARA VACIAR CARRITO -->
<div class="modal-overlay" *ngIf="showClearConfirm" (click)="showClearConfirm = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-icon warning">
      <span class="material-icons">warning</span>
    </div>
    <h3 class="modal-title">¿Vaciar carrito?</h3>
    <p class="modal-text">Esta acción eliminará todos los productos de tu carrito. ¿Deseas continuar?</p>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="showClearConfirm = false">
        Cancelar
      </button>
      <button class="btn-confirm" (click)="confirmClearCart()">
        Sí, vaciar carrito
      </button>
    </div>
  </div>
</div>