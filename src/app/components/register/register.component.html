<!-- Header de navegación -->
<app-home-header></app-home-header>

<!-- Contenedor principal Casa de Música -->
<div class="registro-container">
  <div class="registro-contenido">
    
    <!-- Card principal de registro Casa de Música -->
    <div class="card-registro">
      
      <!-- Header del card Casa de Música -->
      <div class="card-header">
        <!-- Logo Casa de Música -->
        <div class="logo-container">
          <div class="logo-icon">
            <span class="material-symbols-outlined">music_note</span>
          </div>
          <div class="logo-text">
            <h1 class="marca-titulo">Casa de Música</h1>
            <span class="marca-subtitulo">CASTILLO</span>
          </div>
        </div>
        <h2 class="titulo-principal">Crear Cuenta</h2>
        <p class="subtitulo">Únete a la comunidad musical</p>
      </div>

      <!-- Body del card Casa de Música -->
      <div class="card-body">
        
        <!-- Mensaje de error global -->
        <div *ngIf="errorMessage" class="mensaje-error">
          <span class="material-symbols-outlined">warning</span>
          <span>{{ errorMessage }}</span>
        </div>

        <!-- Mensaje de éxito - Verificación de email -->
        <div *ngIf="showEmailVerification" class="mensaje-exito">
          <span class="material-symbols-outlined">check_circle</span>
          <div class="mensaje-contenido">
            <h3>¡Registro Exitoso!</h3>
            <p>{{ successMessage }}</p>
            <p class="mensaje-adicional">Revisa tu bandeja de entrada y carpeta de spam.</p>
            <a routerLink="/login" class="enlace-login-verificacion">
              <span class="material-symbols-outlined">login</span>
              Ir a Iniciar Sesión
            </a>
          </div>
        </div>

        <!-- Formulario Casa de Música -->
        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="formulario-registro">
          
          <!-- Campo Nombre de Usuario -->
          <div class="campo-completo">
            <label for="username" class="etiqueta">
              <span class="material-symbols-outlined">person</span>
              Nombre de usuario
            </label>
            <input 
              type="text" 
              id="username" 
              formControlName="username"
              class="input-campo"
              [class.input-error]="username?.invalid && username?.touched"
              [class.input-valid]="username?.valid && username?.touched"
              placeholder="Nombre de usuario único"
              autocomplete="username"
            >
            <div *ngIf="getFieldError('username')" class="mensaje-validacion error">
              <span class="material-symbols-outlined">error</span>
              <span>{{ getFieldError('username') }}</span>
            </div>
            <div *ngIf="isFieldValid('username')" class="mensaje-validacion success">
              <span class="material-symbols-outlined">check_circle</span>
              <span>Nombre de usuario disponible</span>
            </div>
          </div>

          <!-- Campos Nombre y Apellido -->
          <div class="fila-campos">
            <div class="campo-mitad">
              <label for="firstName" class="etiqueta">
                <span class="material-symbols-outlined">badge</span>
                Nombre
              </label>
              <input 
                type="text" 
                id="firstName" 
                formControlName="firstName"
                class="input-campo"
                [class.input-error]="firstName?.invalid && firstName?.touched"
                [class.input-valid]="firstName?.valid && firstName?.touched"
                placeholder="Tu nombre"
                autocomplete="given-name"
              >
              <div *ngIf="getFieldError('firstName')" class="mensaje-validacion error">
                <span class="material-symbols-outlined">error</span>
                <span>{{ getFieldError('firstName') }}</span>
              </div>
            </div>

            <div class="campo-mitad">
              <label for="lastName" class="etiqueta">
                <span class="material-symbols-outlined">badge</span>
                Apellido
              </label>
              <input 
                type="text" 
                id="lastName" 
                formControlName="lastName"
                class="input-campo"
                [class.input-error]="lastName?.invalid && lastName?.touched"
                [class.input-valid]="lastName?.valid && lastName?.touched"
                placeholder="Tu apellido"
                autocomplete="family-name"
              >
              <div *ngIf="getFieldError('lastName')" class="mensaje-validacion error">
                <span class="material-symbols-outlined">error</span>
                <span>{{ getFieldError('lastName') }}</span>
              </div>
            </div>
          </div>

          <!-- Campo Email con validación mejorada -->
          <div class="campo-completo">
            <label for="email" class="etiqueta">
              <span class="material-symbols-outlined">email</span>
              Email
            </label>
            <input 
              type="email" 
              id="email" 
              formControlName="email"
              class="input-campo"
              [class.input-error]="email?.invalid && email?.touched"
              [class.input-valid]="email?.valid && email?.touched && !getFieldError('email')"
              [class.input-warning]="emailValidationMessage.includes('⚠️')"
              placeholder="ejemplo&#64;gmail.com"
              autocomplete="email"
            >
            <!-- Error de email -->
            <div *ngIf="getFieldError('email')" class="mensaje-validacion error">
              <span class="material-symbols-outlined">error</span>
              <span>{{ getFieldError('email') }}</span>
            </div>
            <!-- Mensaje de validación en tiempo real del dominio -->
            <div *ngIf="emailValidationMessage && !getFieldError('email')" 
                 class="mensaje-validacion"
                 [class.success]="emailValidationMessage.includes('✅')"
                 [class.warning]="emailValidationMessage.includes('⚠️')"
                 [class.error]="emailValidationMessage.includes('❌')">
              <span class="material-symbols-outlined">
                {{ emailValidationMessage.includes('✅') ? 'verified' : 
                   emailValidationMessage.includes('⚠️') ? 'warning' : 'error' }}
              </span>
              <span [innerHTML]="emailValidationMessage"></span>
            </div>
            <!-- Éxito para email válido -->
            <div *ngIf="email?.valid && email?.touched && emailValidationMessage.includes('✅')" 
                 class="mensaje-validacion success">
              <span class="material-symbols-outlined">verified</span>
              <span>Correo electrónico válido y dominio oficial</span>
            </div>
          </div>

          <!-- Campo Contraseña con toggle de visibilidad -->
          <div class="campo-completo">
            <label for="password" class="etiqueta">
              <span class="material-symbols-outlined">lock</span>
              Contraseña
            </label>
            <div class="input-password-container">
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                id="password" 
                formControlName="password"
                class="input-campo input-password"
                [class.input-error]="password?.invalid && password?.touched"
                [class.input-valid]="password?.valid && password?.touched && passwordStrengthMessage.includes('✅')"
                [class.input-warning]="passwordStrengthMessage.includes('⚠️')"
                placeholder="Mínimo 8 caracteres"
                autocomplete="new-password"
              >
              <button 
                type="button" 
                class="toggle-password-btn"
                (click)="togglePasswordVisibility()"
                [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
              >
                <span class="material-symbols-outlined">
                  {{ showPassword ? 'visibility_off' : 'visibility' }}
                </span>
              </button>
            </div>
            
            <!-- Error de contraseña -->
            <div *ngIf="getFieldError('password')" class="mensaje-validacion error">
              <span class="material-symbols-outlined">error</span>
              <span>{{ getFieldError('password') }}</span>
            </div>
            
            <!-- Mensaje de fortaleza en tiempo real -->
            <div *ngIf="passwordStrengthMessage && !getFieldError('password')" 
                 class="mensaje-validacion"
                 [class.success]="passwordStrengthMessage.includes('✅')"
                 [class.warning]="passwordStrengthMessage.includes('⚠️')"
                 [class.error]="passwordStrengthMessage.includes('❌')">
              <span class="material-symbols-outlined">
                {{ passwordStrengthMessage.includes('✅') ? 'verified_user' : 
                   passwordStrengthMessage.includes('⚠️') ? 'warning' : 'error' }}
              </span>
              <span [innerHTML]="passwordStrengthMessage"></span>
            </div>
            
            <!-- Requisitos de contraseña (cuando está escribiendo) -->
            <div *ngIf="password?.value && password?.touched" class="password-requirements">
              <small class="requirements-title">Requisitos de contraseña:</small>
              <div class="requirements-grid">
                <div class="requirement-item" [class.valid]="hasMinLength(password?.value || '')">
                  <span class="material-symbols-outlined">
                    {{ hasMinLength(password?.value || '') ? 'check_circle' : 'radio_button_unchecked' }}
                  </span>
                  <span>8+ caracteres</span>
                </div>
                <div class="requirement-item" [class.valid]="hasUpperCase(password?.value || '')">
                  <span class="material-symbols-outlined">
                    {{ hasUpperCase(password?.value || '') ? 'check_circle' : 'radio_button_unchecked' }}
                  </span>
                  <span>Mayúscula</span>
                </div>
                <div class="requirement-item" [class.valid]="hasLowerCase(password?.value || '')">
                  <span class="material-symbols-outlined">
                    {{ hasLowerCase(password?.value || '') ? 'check_circle' : 'radio_button_unchecked' }}
                  </span>
                  <span>Minúscula</span>
                </div>
                <div class="requirement-item" [class.valid]="hasNumbers(password?.value || '')">
                  <span class="material-symbols-outlined">
                    {{ hasNumbers(password?.value || '') ? 'check_circle' : 'radio_button_unchecked' }}
                  </span>
                  <span>Número</span>
                </div>
                <div class="requirement-item" [class.valid]="hasSpecialChars(password?.value || '')">
                  <span class="material-symbols-outlined">
                    {{ hasSpecialChars(password?.value || '') ? 'check_circle' : 'radio_button_unchecked' }}
                  </span>
                  <span>Símbolo (&#64;$!%*?&)</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Campo Confirmar Contraseña -->
          <div class="campo-completo">
            <label for="confirmPassword" class="etiqueta">
              <span class="material-symbols-outlined">lock_reset</span>
              Confirmar contraseña
            </label>
            <input 
              type="password" 
              id="confirmPassword" 
              formControlName="confirmPassword"
              class="input-campo"
              [class.input-error]="confirmPassword?.invalid && confirmPassword?.touched || (registerForm.errors?.['passwordMismatch'] && confirmPassword?.touched)"
              [class.input-valid]="confirmPassword?.valid && confirmPassword?.touched && !registerForm.errors?.['passwordMismatch']"
              placeholder="Repite tu contraseña"
              autocomplete="new-password"
            >
            <div *ngIf="getConfirmPasswordError()" class="mensaje-validacion error">
              <span class="material-symbols-outlined">error</span>
              <span>{{ getConfirmPasswordError() }}</span>
            </div>
            <div *ngIf="isFieldValid('confirmPassword') && passwordsMatch()" class="mensaje-validacion success">
              <span class="material-symbols-outlined">check_circle</span>
              <span>Las contraseñas coinciden</span>
            </div>
          </div>

          <!-- Botón de registro -->
          <button 
            type="submit" 
            [disabled]="registerForm.invalid || isLoading"
            class="boton-registro"
          >
            <span *ngIf="isLoading" class="material-symbols-outlined loading">sync</span>
            <span *ngIf="!isLoading" class="material-symbols-outlined">person_add</span>
            <span *ngIf="isLoading">Creando cuenta...</span>
            <span *ngIf="!isLoading">Crear Cuenta</span>
          </button>
        </form>

        <!-- Enlaces adicionales -->
        <div class="enlaces-adicionales">
          <div class="separador"></div>
          <div class="enlace-login">
            <span class="texto-enlace">¿Ya tienes cuenta?</span>
            <a routerLink="/login" class="enlace-accion">
              <span class="material-symbols-outlined">login</span>
              Inicia sesión
            </a>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
