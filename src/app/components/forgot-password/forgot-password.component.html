<!-- Header de navegación -->
<app-home-header></app-home-header>

<!-- Contenedor principal Casa de Música -->
<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh; background: linear-gradient(135deg, var(--color-primario) 0%, var(--color-primario-dark) 100%); padding: 2rem 1rem; padding-top: calc(2rem + 80px);">
  <div class="container-sm-modern">
    
    <!-- Card principal Casa de Música -->
    <div class="card-modern card-elevated-modern fade-in" style="max-width: 420px; margin: 0 auto; border-radius: var(--border-radius-2xl); overflow: hidden; box-shadow: var(--shadow-xl);">
      
      <!-- Header del card Casa de Música -->
      <div class="card-header-modern text-center" style="background: linear-gradient(135deg, var(--color-primario) 0%, var(--color-primario-dark) 100%); color: white; border: none; padding: 2.5rem 2rem;">
        <!-- Logo Casa de Música -->
        <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
          <div style="width: 50px; height: 50px; background: var(--color-resalte); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg);">
            <span class="material-symbols-outlined" style="color: var(--color-primario); font-size: 1.5rem;">key</span>
          </div>
          <div class="text-start">
            <h1 style="color: white; font-weight: 700; font-family: var(--font-titulos); margin: 0; font-size: 1.4rem; line-height: 1.2;">Casa de Música</h1>
            <p style="color: var(--color-resalte); margin: 0; font-size: 0.8rem; font-family: var(--font-titulos); font-weight: 600;">CASTILLO</p>
          </div>
        </div>
        <h2 style="color: white; font-weight: 600; font-family: var(--font-titulos); margin-bottom: 0.5rem; font-size: 1.5rem;">¿Olvidaste tu contraseña?</h2>
        <p class="mb-0" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-family: var(--font-cuerpo);">Te enviaremos un enlace para restablecerla</p>
      </div>

      <!-- Body del card Casa de Música -->
      <div class="card-body-modern" style="padding: 2rem;">
        
        <!-- Mensaje de éxito -->
        <div *ngIf="message" class="alert-modern mb-4" style="background: linear-gradient(135deg, var(--color-exito) 0%, #2e7d32 100%); color: white; border-radius: var(--border-radius-lg); padding: 1.25rem; border: none;">
          <div class="d-flex align-items-start gap-3">
            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <span class="material-symbols-outlined" style="color: white; font-size: 1.25rem;">check_circle</span>
            </div>
            <div>
              <strong style="font-family: var(--font-titulos); display: block; margin-bottom: 0.25rem;">¡Email enviado!</strong>
              <p style="margin: 0; font-family: var(--font-cuerpo); font-size: 0.9rem;">{{ message }}</p>
              <small style="opacity: 0.9; display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                <span class="material-symbols-outlined" style="font-size: 1rem;">schedule</span>
                Redirigiendo al login...
              </small>
            </div>
          </div>
        </div>

        <!-- Mensaje de error -->
        <div *ngIf="error" class="alert-modern alert-danger-modern mb-4" style="background: var(--color-error); color: white; border-radius: var(--border-radius-lg); padding: 1rem; border: none;">
          <div class="d-flex align-items-center gap-2">
            <span class="material-symbols-outlined" style="color: white;">warning</span>
            <span style="font-family: var(--font-cuerpo);">{{ error }}</span>
          </div>
        </div>

        <!-- Panel de Rate Limiting -->
        <div *ngIf="isBlocked" class="alert-modern mb-4" style="background: linear-gradient(135deg, #ff6b35 0%, #d84315 100%); color: white; border-radius: var(--border-radius-lg); padding: 1.5rem; border: none;">
          <div class="d-flex align-items-start gap-3">
            <div style="width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <span class="material-symbols-outlined" style="color: white; font-size: 1.5rem;">block</span>
            </div>
            <div class="flex-grow-1">
              <strong style="font-family: var(--font-titulos); display: block; margin-bottom: 0.75rem; font-size: 1.1rem;">
                Demasiados intentos
              </strong>
              <p style="margin: 0 0 1rem 0; font-family: var(--font-cuerpo); font-size: 0.9rem; opacity: 0.95;">
                Has realizado {{ attemptCount }} intentos de recuperación. Por seguridad, debes esperar antes de intentar nuevamente.
              </p>
              <div style="background: rgba(255,255,255,0.15); border-radius: var(--border-radius); padding: 0.75rem; margin-top: 0.75rem;">
                <div class="d-flex align-items-center justify-content-between">
                  <span style="font-size: 0.9rem; font-family: var(--font-cuerpo);">Tiempo restante:</span>
                  <div class="d-flex align-items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size: 1rem;">schedule</span>
                    <strong style="font-family: var(--font-titulos); font-size: 1.1rem;">{{ blockTimeLeft }} min</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Información de intentos restantes -->
        <div *ngIf="!isBlocked && attemptCount > 0" class="alert-modern mb-4" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border-radius: var(--border-radius-lg); padding: 1rem; border: none;">
          <div class="d-flex align-items-center gap-2">
            <span class="material-symbols-outlined" style="color: white; font-size: 1.2rem;">info</span>
            <span style="font-family: var(--font-cuerpo);">
              Has realizado {{ attemptCount }} de {{ maxAttempts }} intentos. 
              Te quedan {{ maxAttempts - attemptCount }} intentos.
            </span>
          </div>
        </div>

        <!-- Formulario Casa de Música -->
        <form [formGroup]="forgotPasswordForm" (ngSubmit)="onSubmit()" *ngIf="!message" class="d-flex flex-column gap-4">
          
          <!-- Campo Email -->
          <div class="form-group">
            <label for="email" class="form-label" style="color: var(--color-primario); font-family: var(--font-titulos); font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center;">
              <span class="material-symbols-outlined" style="margin-right: 0.5rem; color: var(--color-primario); font-size: 1.2rem;">email</span>
              Correo Electrónico
            </label>
            <input 
              type="email" 
              id="email" 
              #emailInput
              formControlName="email"
              [disabled]="isBlocked"
              class="form-control"
              [class.is-invalid]="submitted && f['email'].errors"
              [class.is-valid]="f['email'].valid && f['email'].touched"
              [class.blocked]="isBlocked"
              placeholder="tu-email@ejemplo.com"
              autocomplete="email"
              style="border: 2px solid var(--gray-300); border-radius: var(--border-radius-lg); padding: 0.875rem 1rem; font-family: var(--font-cuerpo); transition: var(--transition);"
            >
            <div *ngIf="submitted && f['email'].errors" class="invalid-feedback" style="color: var(--color-error); font-family: var(--font-cuerpo); margin-top: 0.5rem; display: flex; align-items: center;">
              <span class="material-symbols-outlined" style="font-size: 1rem; margin-right: 0.25rem;">cancel</span>
              <span *ngIf="f['email'].errors?.['required']">El email es requerido</span>
              <span *ngIf="f['email'].errors?.['email']">Formato de email inválido</span>
            </div>
            <div *ngIf="f['email'].valid && f['email'].touched" class="valid-feedback" style="color: var(--color-exito); font-family: var(--font-cuerpo); margin-top: 0.5rem; display: flex; align-items: center;">
              <span class="material-symbols-outlined" style="font-size: 1rem; margin-right: 0.25rem;">check_circle</span>
              <span>Email válido</span>
            </div>
          </div>

          <!-- Botón de submit Casa de Música -->
          <button 
            type="submit" 
            [disabled]="forgotPasswordForm.invalid || loading || isBlocked"
            class="boton-primario w-100 border-0"
            [class.loading]="loading"
            [class.blocked]="isBlocked"
            style="padding: 1rem; font-size: 1rem; margin-top: 0.5rem; transition: var(--transition);"
          >
            <span *ngIf="!loading && !isBlocked" class="d-flex align-items-center justify-content-center gap-2">
              <span class="material-symbols-outlined" style="font-size: 1.2rem;">send</span>
              <span>Enviar enlace de recuperación</span>
            </span>
            <span *ngIf="loading && !isBlocked" class="d-flex align-items-center justify-content-center gap-2">
              <span class="spinner-border spinner-border-sm"></span>
              <span>Enviando...</span>
            </span>
            <span *ngIf="isBlocked" class="d-flex align-items-center justify-content-center gap-2">
              <span class="material-symbols-outlined" style="font-size: 1.2rem;">block</span>
              <span>Bloqueado por {{ blockTimeLeft }} min</span>
            </span>
          </button>

        </form>

        <!-- Información de pasos (solo si no hay mensaje de éxito) -->
        <div *ngIf="!message" class="mt-4 p-3" style="background: var(--color-fondo); border-radius: var(--border-radius-lg); border: 1px solid var(--gray-200);">
          <h4 class="mb-3" style="color: var(--color-primario); font-family: var(--font-titulos); font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-symbols-outlined" style="color: var(--color-resalte);">lightbulb</span>
            ¿Qué sucede después?
          </h4>
          <ul style="list-style: none; padding: 0; margin: 0; font-family: var(--font-cuerpo); font-size: 0.85rem; color: var(--color-texto-secundario);">
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined" style="font-size: 1rem; color: var(--color-accion);">mail</span>
              Recibirás un email en tu bandeja de entrada
            </li>
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined" style="font-size: 1rem; color: var(--color-accion);">link</span>
              Haz clic en el enlace del email
            </li>
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined" style="font-size: 1rem; color: var(--color-accion);">key</span>
              Crea una nueva contraseña segura
            </li>
            <li class="d-flex align-items-center gap-2">
              <span class="material-symbols-outlined" style="font-size: 1rem; color: var(--color-exito);">check_circle</span>
              ¡Listo! Ya puedes iniciar sesión
            </li>
          </ul>
        </div>
      </div>

      <!-- Footer del card Casa de Música -->
      <div class="card-footer-modern" style="background: var(--color-fondo); padding: 1.5rem 2rem; border-top: 2px solid var(--color-resalte);">
        <div class="d-flex flex-column gap-3 text-center">
          
          <!-- Enlace volver al login -->
          <div>
            <a 
              (click)="goBack()"
              class="text-decoration-none transicion"
              style="color: var(--color-primario); font-weight: 600; font-size: 0.9rem; font-family: var(--font-titulos); display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer;"
            >
              <span class="material-symbols-outlined" style="font-size: 1rem;">arrow_back</span>
              Volver al inicio de sesión
            </a>
          </div>

          <!-- Enlace registro -->
          <div>
            <span style="color: var(--color-texto-principal); font-size: 0.9rem; font-family: var(--font-cuerpo);">¿No tienes cuenta?</span>
            <a 
              routerLink="/register"
              class="text-decoration-none transicion"
              style="color: var(--color-accion); font-weight: 700; margin-left: 0.5rem; font-family: var(--font-titulos); display: inline-flex; align-items: center; gap: 0.5rem;"
            >
              <span class="material-symbols-outlined" style="font-size: 1rem;">person_add</span>
              Crear cuenta
            </a>
          </div>
          
        </div>
      </div>

    </div>
  </div>
</div>