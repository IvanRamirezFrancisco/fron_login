<div class="reset-password-container">
  <div class="reset-password-card">
    
    <!-- Loading inicial mientras valida token -->
    <div *ngIf="loading && !tokenValid && !error" class="loading-section">
      <div class="loading-icon">
        <span class="material-icons spinning">lock_clock</span>
      </div>
      <h3>Validando enlace de seguridad</h3>
      <p>Verificando la validez del enlace de restablecimiento</p>
      <div class="loading-spinner"></div>
    </div>

    <!-- Error de token inválido -->
    <div *ngIf="error && !tokenValid" class="error-section">
      <div class="error-icon">
        <span class="material-icons">error_outline</span>
      </div>
      <h2>Enlace no válido o expirado</h2>
      <p class="error-message">{{ error }}</p>
      <div class="error-actions">
        <button (click)="goToLogin()" class="btn-primary">
          <span class="material-icons">login</span>
          Ir al Login
        </button>
        <a routerLink="/forgot-password" class="btn-secondary">
          <span class="material-icons">refresh</span>
          Solicitar nuevo enlace
        </a>
      </div>
    </div>

    <!-- Formulario de reset (cuando el token es válido) -->
    <div *ngIf="tokenValid" class="reset-content">
      
      <!-- Header con icono -->
      <div class="reset-header">
        <div class="icon-container">
          <span class="material-icons">lock_reset</span>
        </div>
        <h1>Restablecer Contraseña</h1>
        <p>Crea una nueva contraseña segura para tu cuenta</p>
      </div>

      <!-- Mensaje de éxito -->
      <div *ngIf="message" class="success-alert">
        <div class="alert-icon">
          <span class="material-icons">check_circle</span>
        </div>
        <div class="alert-content">
          <strong>¡Contraseña actualizada exitosamente!</strong>
          <p>{{ message }}</p>
          <div class="redirect-info">
            <span class="material-icons">info</span>
            <small>Redirigiendo al login en unos segundos...</small>
          </div>
        </div>
      </div>

      <!-- Mensaje de error -->
      <div *ngIf="error && tokenValid" class="error-alert">
        <div class="alert-icon">
          <span class="material-icons">cancel</span>
        </div>
        <div class="alert-content">
          <strong>Error al actualizar contraseña</strong>
          <p>{{ error }}</p>
        </div>
      </div>

      <!-- Formulario -->
      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" *ngIf="!message" class="reset-form">
        
        <!-- Nueva contraseña -->
        <div class="form-group">
          <label for="password" class="form-label">
            <span class="material-icons">lock</span>
            Nueva Contraseña
          </label>
          <div class="input-wrapper">
            <input 
              [type]="showPassword ? 'text' : 'password'"
              id="password"
              formControlName="password"
              class="form-input"
              [class.error]="submitted && f['password'].errors"
              [class.success]="f['password'].valid && f['password'].touched"
              placeholder="Ingresa tu nueva contraseña"
              autocomplete="new-password"
            >
            <button
              type="button"
              class="password-toggle"
              (click)="togglePasswordVisibility('password')"
              [title]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
            >
              <span class="material-icons">{{ showPassword ? 'visibility_off' : 'visibility' }}</span>
            </button>
          </div>

          <!-- Indicador de fortaleza -->
          <div *ngIf="f['password'].value" class="password-strength">
            <div class="strength-bars">
              <div class="strength-bar" [class.weak]="getPasswordStrength(f['password'].value) === 'weak'"
                   [class.medium]="getPasswordStrength(f['password'].value) === 'medium'"
                   [class.strong]="getPasswordStrength(f['password'].value) === 'strong'"></div>
              <div class="strength-bar" [class.medium]="getPasswordStrength(f['password'].value) === 'medium'"
                   [class.strong]="getPasswordStrength(f['password'].value) === 'strong'"></div>
              <div class="strength-bar" [class.strong]="getPasswordStrength(f['password'].value) === 'strong'"></div>
            </div>
            <span class="strength-text" 
                  [class.weak]="getPasswordStrength(f['password'].value) === 'weak'"
                  [class.medium]="getPasswordStrength(f['password'].value) === 'medium'"
                  [class.strong]="getPasswordStrength(f['password'].value) === 'strong'">
              {{ getPasswordStrength(f['password'].value) === 'weak' ? 'Débil' : 
                 getPasswordStrength(f['password'].value) === 'medium' ? 'Media' : 'Fuerte' }}
            </span>
          </div>
          
          <div *ngIf="submitted && f['password'].errors" class="error-message">
            <span class="material-icons">error</span>
            <span *ngIf="f['password'].errors?.['required']">La contraseña es requerida</span>
            <span *ngIf="f['password'].errors?.['minlength']">Mínimo 8 caracteres</span>
            <span *ngIf="f['password'].errors?.['pattern']">Debe cumplir todos los requisitos</span>
          </div>
        </div>

        <!-- Confirmar contraseña -->
        <div class="form-group">
          <label for="confirmPassword" class="form-label">
            <span class="material-icons">lock_check</span>
            Confirmar Contraseña
          </label>
          <div class="input-wrapper">
            <input 
              [type]="showConfirmPassword ? 'text' : 'password'"
              id="confirmPassword"
              formControlName="confirmPassword"
              class="form-input"
              [class.error]="f['confirmPassword'].touched && (!f['confirmPassword'].value || (f['confirmPassword'].value && f['password'].value && f['confirmPassword'].value !== f['password'].value))"
              [class.success]="f['confirmPassword'].value && f['password'].value && f['confirmPassword'].value === f['password'].value && f['confirmPassword'].touched"
              placeholder="Confirma tu nueva contraseña"
              autocomplete="new-password"
            >
            <button 
              type="button"
              class="password-toggle"
              (click)="togglePasswordVisibility('confirmPassword')"
              [title]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
            >
              <span class="material-icons">{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</span>
            </button>
          </div>
          
          <!-- Error: Campo requerido -->
          <div *ngIf="f['confirmPassword'].errors?.['required'] && f['confirmPassword'].touched" class="error-message">
            <span class="material-icons">error</span>
            <span>Debes confirmar tu contraseña</span>
          </div>

          <!-- Error: Contraseñas no coinciden (retroalimentación en tiempo real) -->
          <div *ngIf="f['confirmPassword'].value && f['password'].value && f['confirmPassword'].value !== f['password'].value && f['confirmPassword'].touched" class="error-message">
            <span class="material-icons">cancel</span>
            <span>Las contraseñas no coinciden</span>
          </div>

          <!-- Success: Contraseñas coinciden -->
          <div *ngIf="f['confirmPassword'].value && f['password'].value && f['confirmPassword'].value === f['password'].value && f['confirmPassword'].touched" class="success-message">
            <span class="material-icons">check_circle</span>
            <span>Las contraseñas coinciden perfectamente</span>
          </div>
        </div>

        <!-- Requisitos de contraseña -->
        <div class="password-requirements">
          <h4>
            <span class="material-icons">checklist</span>
            Requisitos de contraseña:
          </h4>
          <ul>
            <li [class.valid]="hasMinLength(f['password'].value)">
              <span class="material-icons">{{ hasMinLength(f['password'].value) ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Mínimo 8 caracteres
            </li>
            <li [class.valid]="hasLowerCase(f['password'].value)">
              <span class="material-icons">{{ hasLowerCase(f['password'].value) ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Al menos una letra minúscula
            </li>
            <li [class.valid]="hasUpperCase(f['password'].value)">
              <span class="material-icons">{{ hasUpperCase(f['password'].value) ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Al menos una letra mayúscula
            </li>
            <li [class.valid]="hasNumbers(f['password'].value)">
              <span class="material-icons">{{ hasNumbers(f['password'].value) ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Al menos un número
            </li>
            <li [class.valid]="hasSpecialChars(f['password'].value)">
              <span class="material-icons">{{ hasSpecialChars(f['password'].value) ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Al menos un símbolo (&#64;$!%*?&)
            </li>
          </ul>
        </div>

        <!-- Botón de submit -->
        <button 
          type="submit" 
          class="btn-submit"
          [disabled]="loading || resetPasswordForm.invalid"
          [class.loading]="loading"
        >
          <span *ngIf="!loading" class="material-icons">lock_reset</span>
          <span *ngIf="loading" class="spinner-icon material-icons spinning">sync</span>
          <span>{{ loading ? 'Actualizando contraseña...' : 'Actualizar Contraseña' }}</span>
        </button>
      </form>

      <!-- Enlaces adicionales -->
      <div class="additional-links" *ngIf="!message">
        <span class="material-icons">info</span>
        <p>
          ¿Recordaste tu contraseña? 
          <a routerLink="/login" class="link">Iniciar sesión</a>
        </p>
      </div>
    </div>
  </div>
</div>