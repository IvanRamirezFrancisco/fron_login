<div class="reset-password-container">
    <div class="reset-password-card">
      <!-- Loading inicial mientras valida token -->
      <div *ngIf="loading && !tokenValid && !error" class="loading-section">
        <div class="spinner-large"></div>
        <h3>Validando enlace...</h3>
        <p>Verificando la validez del enlace de reset</p>
      </div>
  
      <!-- Error de token inválido -->
      <div *ngIf="error && !tokenValid" class="error-section">
        <div class="error-icon">❌</div>
        <h2>Enlace no válido</h2>
        <p>{{ error }}</p>
        <div class="error-actions">
          <button (click)="goToLogin()" class="btn btn-primary">
            Ir al Login
          </button>
          <a routerLink="/forgot-password" class="btn btn-outline">
            Solicitar nuevo enlace
          </a>
        </div>
      </div>
  
      <!-- Formulario de reset (cuando el token es válido) -->
      <div *ngIf="tokenValid" class="card-content">
        <div class="card-header">
          <h2><i class="fas fa-lock" style="margin-right: 0.5rem;"></i> Restablecer Contraseña</h2>
          <p>Crea una nueva contraseña segura para tu cuenta</p>
        </div>
  
        <div class="card-body">
          <!-- Mensaje de éxito -->
          <div *ngIf="message" class="alert alert-success">
            <div class="alert-icon">✅</div>
            <div class="alert-content">
              <strong>¡Contraseña actualizada!</strong>
              <p>{{ message }}</p>
              <small>Redirigiendo al login...</small>
            </div>
          </div>
  
          <!-- Mensaje de error -->
          <div *ngIf="error" class="alert alert-error">
            <div class="alert-icon">❌</div>
            <div class="alert-content">
              <strong>Error</strong>
              <p>{{ error }}</p>
            </div>
          </div>
  
          <!-- Formulario -->
          <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" *ngIf="!message">
            <!-- Nueva contraseña -->
            <div class="form-group">
              <label for="password">Nueva Contraseña *</label>
              <div class="input-group">
                <img src="/assets/icons/password.svg" alt="Password" class="input-icon" style="width: 16px; height: 16px;">
                <input 
                  [type]="showPassword ? 'text' : 'password'"
                  id="password"
                  formControlName="password"
                  class="form-control"
                  [class.is-invalid]="submitted && f['password'].errors"
                  placeholder="Ingresa tu nueva contraseña"
                  autocomplete="new-password"
                >
                <button
                  type="button"
                  class="password-toggle"
                  (click)="togglePasswordVisibility('password')"
                  title="{{ showPassword ? 'Ocultar' : 'Mostrar' }} contraseña"
                >
                  <img [src]="showPassword ? '/assets/icons/eye-closed.svg' : '/assets/icons/eye-open.svg'" 
                       alt="Toggle password visibility" 
                       style="width: 16px; height: 16px;">
                </button>
              </div>
  
              <!-- Indicador de fortaleza -->
              <div *ngIf="f['password'].value" class="password-strength">
                <div class="strength-meter">
                  <div class="strength-bar" [class]="getPasswordStrength(f['password'].value)"></div>
                </div>
                <span class="strength-text" [class]="getPasswordStrength(f['password'].value)">
                  {{ getPasswordStrength(f['password'].value) === 'weak' ? 'Débil' : 
                     getPasswordStrength(f['password'].value) === 'medium' ? 'Media' : 'Fuerte' }}
                </span>
              </div>
              
              <div *ngIf="submitted && f['password'].errors" class="invalid-feedback">
                <small *ngIf="f['password'].errors?.['required']">
                  La contraseña es requerida
                </small>
                <small *ngIf="f['password'].errors?.['minlength']">
                  Mínimo 8 caracteres
                </small>
                <small *ngIf="f['password'].errors?.['pattern']">
                  Debe incluir: mayúscula, minúscula, número y símbolo
                </small>
              </div>
            </div>
  
            <!-- Confirmar contraseña -->
            <div class="form-group">
              <label for="confirmPassword">Confirmar Contraseña *</label>
              <div class="input-group">
                <img src="/assets/icons/password.svg" alt="Password" class="input-icon" style="width: 16px; height: 16px;">
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  id="confirmPassword"
                  formControlName="confirmPassword"
                  class="form-control"
                  [class.is-invalid]="submitted && f['confirmPassword'].errors"
                  placeholder="Confirma tu nueva contraseña"
                  autocomplete="new-password"
                >
                <button 
                  type="button"
                  class="password-toggle"
                  (click)="togglePasswordVisibility('confirmPassword')"
                  title="{{ showConfirmPassword ? 'Ocultar' : 'Mostrar' }} contraseña"
                >
                  <img [src]="showConfirmPassword ? '/assets/icons/eye-closed.svg' : '/assets/icons/eye-open.svg'" 
                       alt="Toggle password visibility" 
                       style="width: 16px; height: 16px;">
                </button>
              </div>
              
              <div *ngIf="submitted && f['confirmPassword'].errors" class="invalid-feedback">
                <small *ngIf="f['confirmPassword'].errors?.['required']">
                  Confirma tu contraseña
                </small>
                <small *ngIf="f['confirmPassword'].errors?.['passwordMismatch']">
                  Las contraseñas no coinciden
                </small>
              </div>
            </div>
  
            <!-- Requisitos de contraseña -->
            <div class="password-requirements">
              <h4>Requisitos de contraseña:</h4>
              <ul>
                <!-- Reemplaza las líneas con regex por: -->
<li [class.valid]="hasMinLength(f['password'].value)">
    ✓ Mínimo 8 caracteres
  </li>
  <li [class.valid]="hasLowerCase(f['password'].value)">
    ✓ Al menos una letra minúscula
  </li>
  <li [class.valid]="hasUpperCase(f['password'].value)">
    ✓ Al menos una letra mayúscula
  </li>
  <li [class.valid]="hasNumbers(f['password'].value)">
    ✓ Al menos un número
  </li>
  <li [class.valid]="hasSpecialChars(f['password'].value)">
    ✓ Al menos un símbolo (&#64;$!%*?&)
  </li>
              </ul>
            </div>
  
            <button 
              type="submit" 
              class="btn btn-primary btn-full"
              [disabled]="loading || resetPasswordForm.invalid"
            >
              <span *ngIf="loading" class="spinner"></span>
              <span *ngIf="!loading"><i class="fas fa-lock" style="margin-right: 0.5rem;"></i> Actualizar Contraseña</span>
              <span *ngIf="loading">Actualizando...</span>
            </button>
          </form>
  
          <!-- Enlaces adicionales -->
          <div class="additional-links" *ngIf="!message">
            <p>
              ¿Recordaste tu contraseña? 
              <a routerLink="/login" class="link">Iniciar sesión</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>